
/* --- RSP v6: Full DB + Atlas (auto-generated) --- */
window.RSP_DB = {
  shenshaCards: [{"名稱": "天乙貴人", "分類": "貴人系", "Buff": "+逢凶化吉", "Debuff": "", "觸發": "危難獲援", "建議": "主動請益", "技能語": "神聖召喚：自動救援", "說明": "逢凶化吉，有人相助解圍"}, {"名稱": "亡神", "分類": "兇煞系", "Buff": "", "Debuff": "官非干擾↑", "觸發": "紛爭官非", "建議": "冷靜止損", "技能語": "亡靈低語：陷入干擾", "說明": "易招官非與干擾"}, {"名稱": "空亡", "分類": "空亡系", "Buff": "", "Debuff": "資源失效", "觸發": "計畫落空", "建議": "重整布局", "技能語": "虛空亂流：技能失效", "說明": "資源失效、誤判"}, {"名稱": "天廚貴人", "分類": "貴人系", "Buff": "恢復力+", "Debuff": "", "觸發": "飲食改善", "建議": "調養身心", "技能語": "美食BUFF：恢復力+", "說明": "食祿豐足、福氣臨"}, {"名稱": "天德貴人", "分類": "貴人系", "Buff": "化煞為權", "Debuff": "", "觸發": "善行感應", "建議": "行善積德", "技能語": "天德庇佑：清除災厄", "說明": "德厚能解煞"}, {"名稱": "天德合", "分類": "合和系", "Buff": "關係回暖", "Debuff": "", "觸發": "調解出現", "建議": "傾聽調解", "技能語": "情感協調：好感+1", "說明": "人際融合協調"}, {"名稱": "天喜", "分類": "桃花系", "Buff": "戀愛喜訊+", "Debuff": "判斷易失衡", "觸發": "告白聯誼", "建議": "勇敢示愛", "技能語": "戀愛觸發：喜悅加倍", "說明": "喜慶桃花臨門"}, {"名稱": "太極貴人", "分類": "貴人系", "Buff": "靈感+分析", "Debuff": "", "觸發": "靈修創作", "建議": "閱讀靜修", "技能語": "太極覺醒：靈感+分析", "說明": "哲思靈感強"}, {"名稱": "天羅地網", "分類": "兇煞系", "Buff": "", "Debuff": "行動受束", "觸發": "受限卡關", "建議": "待時而動", "技能語": "無形束縛：禁用位移", "說明": "束縛難脫"}, {"名稱": "天赦", "分類": "解除系", "Buff": "負面清除", "Debuff": "", "觸發": "官非解脫", "建議": "寬以待己", "技能語": "赦令啟動：負面解除", "說明": "轉危為安的赦令"}, {"名稱": "天醫", "分類": "健康系", "Buff": "回復HP", "Debuff": "", "觸發": "就醫修行", "建議": "休息療癒", "技能語": "天醫加持：HP回復", "說明": "利療癒與復原"}, {"名稱": "天轉", "分類": "命運變動系", "Buff": "劇情重啟", "Debuff": "不穩定↑", "觸發": "重大變動", "建議": "擁抱改變", "技能語": "命運重啟：切線", "說明": "人生劇烈轉向"}, {"名稱": "天羅", "分類": "兇煞系", "Buff": "", "Debuff": "精神壓制", "觸發": "壓力鬱結", "建議": "冥想內觀", "技能語": "心魔出現：情緒波動", "說明": "精神困擾限制"}, {"名稱": "天乙", "分類": "貴人系", "Buff": "全體Buff", "Debuff": "", "觸發": "智性領導", "建議": "結交賢師", "技能語": "天乙降臨：全體Buff", "說明": "尊貴護持"}, {"名稱": "天德(重)", "分類": "貴人系", "Buff": "免疫-", "Debuff": "", "觸發": "善行累積", "建議": "止爭向善", "技能語": "慈悲護身：免疫-", "說明": "仁厚福運"}, {"名稱": "天欺", "分類": "兇煞系", "Buff": "", "Debuff": "判定失準", "觸發": "流言蜚語", "建議": "查證來源", "技能語": "假象迷陣：判定失準", "說明": "真假難辨、被誤導"}, {"名稱": "四廢", "分類": "身弱系", "Buff": "", "Debuff": "延遲行動", "觸發": "動能不足", "建議": "暫緩聚焦", "技能語": "冷卻延長：延遲", "說明": "低迷無力、阻滯"}, {"名稱": "天馬", "分類": "行動系", "Buff": "遠行線開啟", "Debuff": "根基鬆動", "觸發": "外派旅行", "建議": "擁抱變動", "技能語": "驛馬啟動：遠行線", "說明": "遠行搬遷頻繁"}, {"名稱": "天官貴人", "分類": "貴人系", "Buff": "官運↑", "Debuff": "", "觸發": "拔擢任命", "建議": "建立人脈", "技能語": "王者欽點：官運↑", "說明": "仕途有人提攜"}, {"名稱": "太陰", "分類": "陰陽系", "Buff": "干擾-50%", "Debuff": "情緒波動", "觸發": "情緒低潮", "建議": "清靜獨處", "技能語": "沉靜結界：干擾-50%", "說明": "靜謐感受力強"}, {"名稱": "十靈日", "分類": "吉日系", "Buff": "命運共振", "Debuff": "", "觸發": "神聖事件", "建議": "虔誠啟動", "技能語": "靈契啟動：共振", "說明": "靈氣旺盛善啟動"}, {"名稱": "國印", "分類": "貴人系", "Buff": "權威+", "Debuff": "", "觸發": "上級賞識", "建議": "把握任命", "技能語": "國印加持：權威+", "說明": "權柄加持、易升遷"}, {"名稱": "月德合", "分類": "合和系", "Buff": "親密上升", "Debuff": "", "觸發": "交際場合", "建議": "拓展人脈", "技能語": "人和氣場：親密↑", "說明": "人緣佳、受歡迎"}, {"名稱": "吊客", "分類": "兇煞系", "Buff": "冷靜自持", "Debuff": "交際-", "觸發": "社交退避", "建議": "內省自處", "技能語": "孤星降臨：交際難", "說明": "孤僻冷淡、不擅社交"}, {"名稱": "將星", "分類": "領導系", "Buff": "士氣↑", "Debuff": "壓力↑", "觸發": "被推為首", "建議": "明確目標", "技能語": "領袖出征：士氣↑", "說明": "領導統御力"}, {"名稱": "孤辰", "分類": "孤寂系", "Buff": "直覺+", "Debuff": "孤立感", "觸發": "拒群獨行", "建議": "深化內觀", "技能語": "內觀模式：直覺+", "說明": "內在孤獨、喜獨處"}, {"名稱": "孤鸞煞", "分類": "情感系", "Buff": "自省成長", "Debuff": "戀愛延遲", "觸發": "分合反覆", "建議": "先整合自我", "技能語": "情感缺損：延遲", "說明": "情路坎坷"}, {"名稱": "學堂", "分類": "智慧系", "Buff": "學力+", "Debuff": "眼高手低", "觸發": "備考進修", "建議": "系統複習", "技能語": "書卷加持：學力+", "說明": "學業考試優勢"}, {"名稱": "詞館", "分類": "智慧系", "Buff": "說服+", "Debuff": "口舌是非", "觸發": "演講發表", "建議": "多練口說", "技能語": "詞語風暴：說服↑", "說明": "口語表達佳"}, {"名稱": "德秀貴人", "分類": "智慧系", "Buff": "名列前茅", "Debuff": "驕矜風險", "觸發": "升學晉升", "建議": "低調蓄勢", "技能語": "德秀登科：排名↑", "說明": "才德兼備"}, {"名稱": "華蓋", "分類": "藝術系", "Buff": "靈感全開", "Debuff": "孤傲", "觸發": "創作爆發", "建議": "多展演", "技能語": "藝術降臨：靈感全開", "說明": "藝術天賦高"}, {"名稱": "桃花", "分類": "桃花系", "Buff": "吸引x2", "Debuff": "爛桃花風險", "觸發": "社交熱絡", "建議": "慎選對象", "技能語": "魅惑之眼：吸引x2", "說明": "魅力佳"}, {"名稱": "專門", "分類": "職能系", "Buff": "天賦覺醒", "Debuff": "鑽牛角尖", "觸發": "專案展能", "建議": "深耕技能", "技能語": "技能解鎖：覺醒", "說明": "專業天賦明顯"}, {"名稱": "陰差陽錯", "分類": "命運錯位系", "Buff": "另闢蹊徑", "Debuff": "關係錯位", "觸發": "姻緣不協", "建議": "調整預期", "技能語": "命運偏移：關係錯位", "說明": "錯配錯置"}, {"名稱": "披麻", "分類": "喪事系", "Buff": "珍惜當下", "Debuff": "福氣↓", "觸發": "奔喪探病", "建議": "慎言慎行", "技能語": "哀運籠罩：福氣↓", "說明": "有喪服之憂"}, {"名稱": "流霞", "分類": "情感系", "Buff": "社交熱度+", "Debuff": "判斷-", "觸發": "多重追求", "建議": "設界限", "技能語": "爛桃花纏身：判斷-", "說明": "情感混亂"}, {"名稱": "紅鸞", "分類": "桃花系", "Buff": "正緣上線", "Debuff": "粉紅濾鏡", "觸發": "告白相遇", "建議": "把握良緣", "技能語": "戀愛觸發：正緣", "說明": "良緣臨門"}, {"名稱": "羊刃", "分類": "刑煞系", "Buff": "爆擊+", "Debuff": "衝突↑", "觸發": "遭挑釁", "建議": "控管情緒", "技能語": "怒氣爆擊：衝突↑", "說明": "衝突易發"}, {"名稱": "血刃", "分類": "刑煞系", "Buff": "警覺↑", "Debuff": "HP-", "觸發": "刀火險境", "建議": "避險謹慎", "技能語": "失血破財：HP-", "說明": "破財血光"}, {"名稱": "蜚廉", "分類": "口舌系", "Buff": "口條訓練", "Debuff": "好感↓", "觸發": "失言誤解", "建議": "慎言", "技能語": "口舌之災：好感↓", "說明": "言語爭端"}, {"名稱": "金輿", "分類": "財富系", "Buff": "資源滿格", "Debuff": "享樂過度", "觸發": "資源匯聚", "建議": "分享成果", "技能語": "黃金上座：資源滿", "說明": "富貴吉星"}, {"名稱": "金神", "分類": "特殊格局系", "Buff": "爆發+防禦", "Debuff": "剛烈過猛", "觸發": "困境反彈", "建議": "苦中修成", "技能語": "烈焰修煉：爆防+", "說明": "火煉成鋼"}, {"名稱": "飛刃", "分類": "刑煞系", "Buff": "斬斷阻礙", "Debuff": "兩敗俱傷", "觸發": "怒而動手", "建議": "退一步", "技能語": "雙刃斬擊：兩敗俱傷", "說明": "武力爆發"}, {"名稱": "馬星", "分類": "行動系", "Buff": "刷新場景", "Debuff": "漂泊感", "觸發": "搬家外派", "建議": "善用移動", "技能語": "出走模式：刷新場景", "說明": "走動搬遷多"}, {"名稱": "關煞", "分類": "兇煞系", "Buff": "法務意識", "Debuff": "官司風險", "觸發": "爭訟官非", "建議": "合法應對", "技能語": "審判降臨：官煞現形", "說明": "司法風險"}, {"名稱": "詩禍", "分類": "文字煞系", "Buff": "審稿意識", "Debuff": "名聲翻車", "觸發": "發文失當", "建議": "審稿再發", "技能語": "文煞降臨：名聲翻車", "說明": "文字惹禍"}, {"名稱": "貴人背", "分類": "背運系", "Buff": "自力更生", "Debuff": "援手缺席", "觸發": "援手不在", "建議": "靠自己", "技能語": "斷援之刻：貴人無效", "說明": "遇不到助力"}, {"名稱": "十惡大敗", "分類": "破格系", "Buff": "警戒升級", "Debuff": "全屬性-", "觸發": "大敗日辦事", "建議": "改期", "技能語": "大敗觸發：全屬性-", "說明": "諸事不宜"}, {"名稱": "孤辰寡宿", "分類": "孤寂系", "Buff": "內心強化", "Debuff": "戀愛關閉", "觸發": "人際疏離", "建議": "修煉內在", "技能語": "孤星高掛：戀愛關閉", "說明": "不利婚姻"}, {"名稱": "元辰", "分類": "命格偏差系", "Buff": "校準導航", "Debuff": "方向錯亂", "觸發": "方向偏移", "建議": "修正策略", "技能語": "命途迷障：重選", "說明": "偏見混亂"}, {"名稱": "網羅密布", "分類": "兇煞系", "Buff": "偵測陷阱", "Debuff": "行動受限", "觸發": "外力阻擋", "建議": "降載暫緩", "技能語": "束縛之網：受限", "說明": "努力卡關"}, {"名稱": "學堂(增)", "分類": "智慧系", "Buff": "上限+", "Debuff": "壓力+", "觸發": "升學選拔", "建議": "規律複習", "技能語": "學力暴增：上限+", "說明": "考運佳"}, {"名稱": "詞館(增)", "分類": "智慧系", "Buff": "說服+", "Debuff": "口角風險", "觸發": "辯論演說", "建議": "訓練口說", "技能語": "詞鋒閃現：說服+", "說明": "語言表達強"}, {"名稱": "德秀貴人(增)", "分類": "智慧系", "Buff": "人緣UP", "Debuff": "自滿風險", "觸發": "評比晉升", "建議": "維持品格", "技能語": "德秀榮耀：人緣UP", "說明": "德才兼備"}, {"名稱": "孤辰寡宿(增)", "分類": "孤寂系", "Buff": "靈感+", "Debuff": "社交-", "觸發": "情感冷卻", "建議": "靜心修煉", "技能語": "孤獨冥想：靈感+", "說明": "適合自省創作"}, {"名稱": "元辰(增)", "分類": "命格偏差系", "Buff": "目標重選", "Debuff": "路線漂移", "觸發": "計畫多變", "建議": "順勢修正", "技能語": "轉輪：目標重選", "說明": "路線漂移"}, {"名稱": "四廢(增)", "分類": "身弱系", "Buff": "聚焦微進", "Debuff": "冷卻翻倍", "觸發": "動能不足", "建議": "短目標", "技能語": "冷卻翻倍：延遲", "說明": "氣弱難成"}, {"名稱": "網羅密布(增)", "分類": "兇煞系", "Buff": "陷阱偵測", "Debuff": "硬直", "觸發": "層層阻礙", "建議": "降低投入", "技能語": "束縛之網：硬直", "說明": "運勢難破"}, {"名稱": "蜚廉(增)", "分類": "口舌系", "Buff": "話術訓練", "Debuff": "好感下降", "觸發": "口角爭執", "建議": "慎言退讓", "技能語": "口舌之災：好感↓", "說明": "易招非議"}],
  nayin: [{"干支組合": "甲子·乙丑", "納音五行": "海中金", "戰場主題": "鋒芒工坊", "環境Buff": "鋒芒+專注", "風險Debuff": "剛硬僵化", "事件鉤子": "打磨自我，慎防剛過易折"}, {"干支組合": "丙寅·丁卯", "納音五行": "爐中火", "戰場主題": "炎煌熔場", "環境Buff": "爆發+士氣", "風險Debuff": "躁進失衡", "事件鉤子": "以戰養戰，注意冷卻"}, {"干支組合": "戊辰·己巳", "納音五行": "大林木", "戰場主題": "樹靈林域", "環境Buff": "成長+恢復", "風險Debuff": "優柔拖延", "事件鉤子": "持續精進，避免擺盪"}, {"干支組合": "庚午·辛未", "納音五行": "路旁土", "戰場主題": "厚土要塞", "環境Buff": "穩定+耐久", "風險Debuff": "遲滯固著", "事件鉤子": "穩中求變，防過度保守"}, {"干支組合": "壬申·癸酉", "納音五行": "劍鋒金", "戰場主題": "鋒芒工坊", "環境Buff": "鋒芒+專注", "風險Debuff": "剛硬僵化", "事件鉤子": "打磨自我，慎防剛過易折"}, {"干支組合": "甲戌·乙亥", "納音五行": "山頭火", "戰場主題": "炎煌熔場", "環境Buff": "爆發+士氣", "風險Debuff": "躁進失衡", "事件鉤子": "以戰養戰，注意冷卻"}, {"干支組合": "丙子·丁丑", "納音五行": "澗下水", "戰場主題": "流影水境", "環境Buff": "流動+適應", "風險Debuff": "分散渙散", "事件鉤子": "柔中帶剛，聚焦主線"}, {"干支組合": "戊寅·己卯", "納音五行": "城頭土", "戰場主題": "厚土要塞", "環境Buff": "穩定+耐久", "風險Debuff": "遲滯固著", "事件鉤子": "穩中求變，防過度保守"}, {"干支組合": "庚辰·辛巳", "納音五行": "白蠟金", "戰場主題": "鋒芒工坊", "環境Buff": "鋒芒+專注", "風險Debuff": "剛硬僵化", "事件鉤子": "打磨自我，慎防剛過易折"}, {"干支組合": "壬午·癸未", "納音五行": "楊柳木", "戰場主題": "樹靈林域", "環境Buff": "成長+恢復", "風險Debuff": "優柔拖延", "事件鉤子": "持續精進，避免擺盪"}, {"干支組合": "甲申·乙酉", "納音五行": "泉中水", "戰場主題": "流影水境", "環境Buff": "流動+適應", "風險Debuff": "分散渙散", "事件鉤子": "柔中帶剛，聚焦主線"}, {"干支組合": "丙戌·丁亥", "納音五行": "屋上土", "戰場主題": "厚土要塞", "環境Buff": "穩定+耐久", "風險Debuff": "遲滯固著", "事件鉤子": "穩中求變，防過度保守"}, {"干支組合": "戊子·己丑", "納音五行": "霹靂火", "戰場主題": "炎煌熔場", "環境Buff": "爆發+士氣", "風險Debuff": "躁進失衡", "事件鉤子": "以戰養戰，注意冷卻"}, {"干支組合": "庚寅·辛卯", "納音五行": "松柏木", "戰場主題": "樹靈林域", "環境Buff": "成長+恢復", "風險Debuff": "優柔拖延", "事件鉤子": "持續精進，避免擺盪"}, {"干支組合": "壬辰·癸巳", "納音五行": "長流水", "戰場主題": "流影水境", "環境Buff": "流動+適應", "風險Debuff": "分散渙散", "事件鉤子": "柔中帶剛，聚焦主線"}, {"干支組合": "甲午·乙未", "納音五行": "沙中金", "戰場主題": "鋒芒工坊", "環境Buff": "鋒芒+專注", "風險Debuff": "剛硬僵化", "事件鉤子": "打磨自我，慎防剛過易折"}, {"干支組合": "丙申·丁酉", "納音五行": "山下火", "戰場主題": "炎煌熔場", "環境Buff": "爆發+士氣", "風險Debuff": "躁進失衡", "事件鉤子": "以戰養戰，注意冷卻"}, {"干支組合": "戊戌·己亥", "納音五行": "平地木", "戰場主題": "樹靈林域", "環境Buff": "成長+恢復", "風險Debuff": "優柔拖延", "事件鉤子": "持續精進，避免擺盪"}, {"干支組合": "庚子·辛丑", "納音五行": "壁上土", "戰場主題": "厚土要塞", "環境Buff": "穩定+耐久", "風險Debuff": "遲滯固著", "事件鉤子": "穩中求變，防過度保守"}, {"干支組合": "壬寅·癸卯", "納音五行": "金箔金", "戰場主題": "鋒芒工坊", "環境Buff": "鋒芒+專注", "風險Debuff": "剛硬僵化", "事件鉤子": "打磨自我，慎防剛過易折"}, {"干支組合": "甲辰·乙巳", "納音五行": "覆燈火", "戰場主題": "炎煌熔場", "環境Buff": "爆發+士氣", "風險Debuff": "躁進失衡", "事件鉤子": "以戰養戰，注意冷卻"}, {"干支組合": "丙午·丁未", "納音五行": "天河水", "戰場主題": "流影水境", "環境Buff": "流動+適應", "風險Debuff": "分散渙散", "事件鉤子": "柔中帶剛，聚焦主線"}, {"干支組合": "戊申·己酉", "納音五行": "大驛土", "戰場主題": "厚土要塞", "環境Buff": "穩定+耐久", "風險Debuff": "遲滯固著", "事件鉤子": "穩中求變，防過度保守"}, {"干支組合": "庚戌·辛亥", "納音五行": "釵釧金", "戰場主題": "鋒芒工坊", "環境Buff": "鋒芒+專注", "風險Debuff": "剛硬僵化", "事件鉤子": "打磨自我，慎防剛過易折"}, {"干支組合": "壬子·癸丑", "納音五行": "桑柘木", "戰場主題": "樹靈林域", "環境Buff": "成長+恢復", "風險Debuff": "優柔拖延", "事件鉤子": "持續精進，避免擺盪"}, {"干支組合": "甲寅·乙卯", "納音五行": "大溪水", "戰場主題": "流影水境", "環境Buff": "流動+適應", "風險Debuff": "分散渙散", "事件鉤子": "柔中帶剛，聚焦主線"}, {"干支組合": "丙辰·丁巳", "納音五行": "沙中土", "戰場主題": "厚土要塞", "環境Buff": "穩定+耐久", "風險Debuff": "遲滯固著", "事件鉤子": "穩中求變，防過度保守"}, {"干支組合": "戊午·己未", "納音五行": "天上火", "戰場主題": "炎煌熔場", "環境Buff": "爆發+士氣", "風險Debuff": "躁進失衡", "事件鉤子": "以戰養戰，注意冷卻"}, {"干支組合": "庚申·辛酉", "納音五行": "石榴木", "戰場主題": "樹靈林域", "環境Buff": "成長+恢復", "風險Debuff": "優柔拖延", "事件鉤子": "持續精進，避免擺盪"}, {"干支組合": "壬戌·癸亥", "納音五行": "大海水", "戰場主題": "流影水境", "環境Buff": "流動+適應", "風險Debuff": "分散渙散", "事件鉤子": "柔中帶剛，聚焦主線"}],
  tenGods: [{"key": "比肩", "角色定位": "自信勇者", "主技": "自我強化", "Buff": "攻防+ 抗壓+", "Debuff": "固執", "觸發": "競爭/挑戰"}, {"key": "劫財", "角色定位": "叛逆同盟者", "主技": "結盟奪資", "Buff": "共享資源", "Debuff": "內鬥", "觸發": "資源分配"}, {"key": "食神", "角色定位": "福祿創造者", "主技": "滋養恢復", "Buff": "恢復士氣", "Debuff": "怠惰", "觸發": "慶典/療癒"}, {"key": "傷官", "角色定位": "突破行者", "主技": "創新破格", "Buff": "短期突破", "Debuff": "沖撞", "觸發": "改革/挑戰"}, {"key": "正財", "角色定位": "穩健管理者", "主技": "資源管理", "Buff": "穩定成長", "Debuff": "保守", "觸發": "財務/執行"}, {"key": "偏財", "角色定位": "機運獵手", "主技": "捕捉機會", "Buff": "意外獲益", "Debuff": "投機失誤", "觸發": "機會來臨"}, {"key": "正官", "角色定位": "秩序守衛者", "主技": "規範防衛", "Buff": "秩序穩定", "Debuff": "僵化", "觸發": "考核/制度"}, {"key": "七殺", "角色定位": "突破武士", "主技": "逆境爆發", "Buff": "戰力暴增", "Debuff": "魯莽", "觸發": "危急壓力"}, {"key": "正印", "角色定位": "仁愛守護者", "主技": "庇護教化", "Buff": "心理回復", "Debuff": "依賴", "觸發": "救援/教學"}, {"key": "偏印", "角色定位": "靈感塑形者", "主技": "變通啟發", "Buff": "靈感創新", "Debuff": "多疑", "觸發": "靈光/轉換"}]
};

(function() {
  // Floating launcher
  const btn = document.createElement('button');
  btn.textContent = '📚 圖鑑';
  btn.style.cssText = 'position:fixed;right:16px;bottom:16px;z-index:2147483647;padding:10px 14px;border-radius:12px;border:1px solid #203044;background:#0e1622;color:#e8f0ff;box-shadow:0 8px 20px rgba(0,0,0,.35);cursor:pointer';
  document.body.appendChild(btn);

  // Shadow DOM Drawer
  const host = document.createElement('div');
  host.style.cssText = 'position:fixed;inset:0;display:none;z-index:2147483646;';
  document.body.appendChild(host);
  const shadowRoot = host.attachShadow({mode:'open'});

  shadowRoot.innerHTML = `
    <style>
      .backdrop { position:fixed; inset:0; background:rgba(9,14,20,.66); backdrop-filter: blur(4px); }
      .panel { position:fixed; right:0; top:0; height:100%; width:min(860px,95vw); background:#0b0f14; color:#e8f0ff; border-left:1px solid #203044; box-shadow: -8px 0 24px rgba(0,0,0,.4); display:flex; flex-direction:column; }
      .hd { display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid #203044; }
      .tab { margin-right:8px; padding:6px 10px; border-radius:10px; border:1px solid #203044; background:#111722; cursor:pointer; }
      .tab.active { background:#192234; }
      .search { margin-left:auto; background:#0e1622; border:1px solid #203044; border-radius:8px; padding:6px 10px; color:#e8f0ff; width: 220px; }
      .toolbar { display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid #203044; align-items:center; }
      .select { background:#0e1622; color:#e8f0ff; border:1px solid #203044; border-radius:8px; padding:6px 10px; }
      .list { overflow:auto; padding:12px; display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:10px; }
      .card { border:1px solid #203044; border-radius:12px; padding:10px 12px; background:linear-gradient(180deg,rgba(255,255,255,.02),transparent); }
      .muted { color:#9fb0c3; }
      .k { color:#9fb0c3; font-size:12px; }
      details > summary { cursor:pointer; }
    </style>
    <div class="backdrop"></div>
    <div class="panel">
      <div class="hd">
        <strong>虹靈御所｜資料圖鑑 v6</strong>
        <button class="tab active" data-tab="shensha">神煞兵符</button>
        <button class="tab" data-tab="nayin">納音戰場</button>
        <button class="tab" data-tab="ten">十神技能</button>
        <input class="search" placeholder="搜尋（名稱／分類／說明…）" />
      </div>
      <div class="toolbar">
        <label class="k">分類</label>
        <select class="select selCat">
          <option value="">全部分類</option>
        </select>
        <label class="k">排序</label>
        <select class="select selSort">
          <option value="">預設</option>
          <option value="name">名稱</option>
          <option value="cat">分類</option>
        </select>
      </div>
      <div class="list"></div>
    </div>
  `;

  const qs = s=>shadowRoot.querySelector(s);
  const qsa = s=>shadowRoot.querySelectorAll(s);
  const backdrop = qs('.backdrop');
  const list = qs('.list');
  const tabs = qsa('.tab');
  const search = qs('.search');
  const selCat = qs('.selCat');
  const selSort = qs('.selSort');
  let tab = 'shensha';

  // Fill category options (for shensha)
  const cats = Array.from(new Set((window.RSP_DB.shenshaCards||[]).map(r=>r.分類))).sort();
  cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; selCat.appendChild(o); });

  function renderCard(obj) {
    const el = document.createElement('div');
    el.className = 'card';
    if (tab==='shensha') {
      el.innerHTML = `
        <details open>
          <summary><strong>${obj.名稱}</strong> <span class="muted">｜${obj.分類}</span></summary>
          <div><span class="muted">Buff：</span>${obj.Buff||'-'}</div>
          <div><span class="muted">Debuff：</span>${obj.Debuff||'-'}</div>
          <div><span class="muted">觸發：</span>${obj.觸發||'-'}</div>
          <div><span class="muted">建議：</span>${obj.建議||'-'}</div>
          <div><span class="muted">技能語：</span>${obj.技能語||'-'}</div>
          <div class="muted" style="margin-top:6px;">${obj.說明||''}</div>
        </details>`;
    } else if (tab==='nayin') {
      el.innerHTML = `
        <strong>${obj.干支組合}</strong> <span class="muted">｜${obj.納音五行}</span>
        <div><span class="muted">戰場：</span>${obj.戰場主題}</div>
        <div><span class="muted">環境Buff：</span>${obj.環境Buff}</div>
        <div><span class="muted">風險Debuff：</span>${obj.風險Debuff}</div>
        <div class="muted">${obj.事件鉤子}</div>`;
    } else {
      el.innerHTML = `
        <strong>${obj.key}</strong> <span class="muted">｜${obj.角色定位}</span>
        <div><span class="muted">主技：</span>${obj.主技}</div>
        <div><span class="muted">Buff：</span>${obj.Buff}</div>
        <div><span class="muted">Debuff：</span>${obj.Debuff}</div>
        <div><span class="muted">觸發：</span>${obj.觸發}</div>`;
    }
    return el;
  }

  function dataForTab() {
    if (tab==='shensha') return window.RSP_DB.shenshaCards||[];
    if (tab==='nayin') return window.RSP_DB.nayin||[];
    return window.RSP_DB.tenGods||[];
  }

  function render() {
    const q = (search.value||'').toLowerCase();
    const cat = selCat.value;
    let data = dataForTab();
    if (tab==='shensha' && cat) data = data.filter(r => r.分類===cat);
    if (q) data = data.filter(r => JSON.stringify(r).toLowerCase().includes(q));
    if (selSort.value==='name') {
      const key = tab==='nayin'?'干支組合':(tab==='ten'?'key':'名稱');
      data = data.slice().sort((a,b)=>String(a[key]).localeCompare(String(b[key])));
    } else if (selSort.value==='cat' && tab==='shensha') {
      data = data.slice().sort((a,b)=>String(a.分類).localeCompare(String(b.分類)));
    }
    list.innerHTML='';
    data.forEach(obj=> list.appendChild(renderCard(obj)));
  }

  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
    tab = t.dataset.tab; 
    // toggle category filter visibility
    selCat.parentElement.style.display = (tab==='shensha') ? 'flex' : 'none';
    render();
  }));
  search.addEventListener('input', render);
  selCat.addEventListener('change', render);
  selSort.addEventListener('change', render);
  shadowRoot.querySelector('.backdrop').addEventListener('click', () => host.style.display='none');
  btn.addEventListener('click', () => { host.style.display='block'; render(); });

  // Try to expose minimal API
  window.__rainbowDB = window.RSP_DB;
})();
/* --- end RSP v6 --- */
